<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Binus Insurance Cost</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h1 class="mb-4">Insurance Cost Dashboard</h1>

      <nav class="mb-4">
        <a href="/" class="btn btn-primary me-2">Dashboard</a>
        <a href="/predict" class="btn btn-outline-primary me-2">Prediksi Biaya</a
        >
        <a href="https://github.com/fnzip/binus-dwmp" target="_blank" class="btn btn-outline-primary">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github mb-1" viewBox="0 0 16 16">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8"/>
          </svg>
        </a>
      </nav>

      <div class="row mb-5">
        <div class="col-md-6 mb-4">
          <h5>Region Average Charges</h5>
          <div
            id="regionMap"
            class="mb-3"
            style="width: 100%; max-width: 100%; overflow-x: auto"
          ></div>
        </div>
        <div class="col-md-6 mb-4">
          <h5>Smoker vs Non-Smoker (Avg Charges)</h5>
          <canvas id="boxplotChart"></canvas>
        </div>
      </div>
      <div class="row mb-5">
        <div class="col-md-6 mb-4">
          <h5>Average Charges by Age</h5>
          <canvas id="ageChart"></canvas>
        </div>
        <div class="col-md-6 mb-4">
          <h5>Correlation Matrix</h5>
          <canvas id="corrChart"></canvas>
          <div id="corrTable" class="mt-3"></div>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
      // Fetch and render region average chart and SVG map
      fetch("/api/region-avg")
        .then((r) => r.json())
        .then((data) => {
          // Render SVG map with costs
          fetch("/ui/area.svg")
            .then((r) => r.text())
            .then((svg) => {
              // Replace {cost} in SVG for each region
              const costMap = {};
              data.forEach((d) => {
                costMap[d.region.toLowerCase()] = d.charges;
              });
              svg = svg.replace(
                "Northwest {cost}",
                `Northwest $${
                  costMap["northwest"]
                    ? Math.round(costMap["northwest"]).toLocaleString()
                    : "-"
                }`
              );
              svg = svg.replace(
                "Southwest {cost}",
                `Southwest $${
                  costMap["southwest"]
                    ? Math.round(costMap["southwest"]).toLocaleString()
                    : "-"
                }`
              );
              svg = svg.replace(
                "Southeast {cost}",
                `Southeast $${
                  costMap["southeast"]
                    ? Math.round(costMap["southeast"]).toLocaleString()
                    : "-"
                }`
              );
              svg = svg.replace(
                "Northeast {cost}",
                `Northeast $${
                  costMap["northeast"]
                    ? Math.round(costMap["northeast"]).toLocaleString()
                    : "-"
                }`
              );
              // Make SVG responsive
              svg = svg.replace(
                "<svg ",
                '<svg style="width:100%;height:auto;max-width:100%;" '
              );
              document.getElementById("regionMap").innerHTML = svg;
            });
        });
      // Smoker vs Non-Smoker (Avg Charges)
      fetch("/api/boxplot-smoker")
        .then((r) => r.json())
        .then((data) => {
          const ctx = document.getElementById("boxplotChart").getContext("2d");
          new Chart(ctx, {
            type: "bar",
            data: {
              labels: data.map((d) => d.smoker),
              datasets: [
                {
                  label: "Avg Charges",
                  data: data.map((d) => d.avg_charges),
                  backgroundColor: "#ff9800",
                },
              ],
            },
            options: { responsive: true },
          });
        });
      // Age average line chart
      fetch("/api/age-avg")
        .then((r) => r.json())
        .then((data) => {
          const ctx = document.getElementById("ageChart").getContext("2d");
          new Chart(ctx, {
            type: "line",
            data: {
              labels: data.map((d) => d.age),
              datasets: [
                {
                  label: "Avg Charges",
                  data: data.map((d) => d.charges),
                  borderColor: "#388e3c",
                  fill: false,
                },
              ],
            },
            options: { responsive: true },
          });
        });
      // Correlation matrix as table and matrix chart
      fetch("/api/corr")
        .then((r) => r.json())
        .then((corr) => {
          const keys = Object.keys(corr);
          // Render as matrix chart (using bubble chart)
          const ctx = document.getElementById("corrChart").getContext("2d");
          const matrixData = [];
          keys.forEach((row, i) => {
            keys.forEach((col, j) => {
              matrixData.push({
                x: j + 1,
                y: i + 1,
                r: Math.abs(corr[row][col]) * 20,
                v: corr[row][col],
              });
            });
          });
          new Chart(ctx, {
            type: "bubble",
            data: {
              datasets: [
                {
                  label: "Correlation",
                  data: matrixData,
                  backgroundColor: matrixData.map((d) =>
                    d.v > 0 ? "#388e3c" : "#e53935"
                  ),
                },
              ],
            },
            options: {
              scales: {
                x: {
                  min: 0,
                  max: keys.length + 1,
                  ticks: { callback: (v) => keys[v - 1] || "" },
                },
                y: {
                  min: 0,
                  max: keys.length + 1,
                  ticks: { callback: (v) => keys[v - 1] || "" },
                },
              },
              plugins: { legend: { display: false } },
              responsive: true,
            },
          });
        });
    </script>
  </body>
</html>
