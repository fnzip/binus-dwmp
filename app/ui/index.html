<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <nav class="mb-4">
        <a href="/" class="btn btn-outline-primary me-2">Dashboard</a>
        <a href="/predict" class="btn btn-primary">Prediksi Biaya Asuransi</a>
      </nav>
      <h1 class="mb-4">Insurance Cost Dashboard</h1>
      <div class="row mb-5">
        <div class="col-md-6 mb-4">
          <h5>Region Average Charges</h5>
          <div id="regionMap" class="mb-3"></div>
          <canvas id="regionChart"></canvas>
        </div>
        <div class="col-md-6 mb-4">
          <h5>Smoker vs Non-Smoker (Avg Charges)</h5>
          <canvas id="boxplotChart"></canvas>
        </div>
      </div>
      <div class="row mb-5">
        <div class="col-md-6 mb-4">
          <h5>Average Charges by Age</h5>
          <canvas id="ageChart"></canvas>
        </div>
        <div class="col-md-6 mb-4">
          <h5>Correlation Matrix</h5>
          <canvas id="corrChart"></canvas>
          <div id="corrTable" class="mt-3"></div>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
      // Fetch and render region average chart and SVG map
      fetch("/api/region-avg")
        .then((r) => r.json())
        .then((data) => {
          // Render SVG map with costs
          fetch("/ui/area.svg")
            .then((r) => r.text())
            .then((svg) => {
              // Replace {cost} in SVG for each region
              const costMap = {};
              data.forEach((d) => {
                costMap[d.region.toLowerCase()] = d.charges;
              });
              svg = svg.replace(
                "Northwest {cost}",
                `Northwest $${
                  costMap["northwest"]
                    ? Math.round(costMap["northwest"]).toLocaleString()
                    : "-"
                }`
              );
              svg = svg.replace(
                "Southwest {cost}",
                `Southwest $${
                  costMap["southwest"]
                    ? Math.round(costMap["southwest"]).toLocaleString()
                    : "-"
                }`
              );
              svg = svg.replace(
                "Southeast {cost}",
                `Southeast $${
                  costMap["southeast"]
                    ? Math.round(costMap["southeast"]).toLocaleString()
                    : "-"
                }`
              );
              svg = svg.replace(
                "Northeast {cost}",
                `Northeast $${
                  costMap["northeast"]
                    ? Math.round(costMap["northeast"]).toLocaleString()
                    : "-"
                }`
              );
              document.getElementById("regionMap").innerHTML = svg;
            });
          // Bar chart
          const ctx = document.getElementById("regionChart").getContext("2d");
          new Chart(ctx, {
            type: "bar",
            data: {
              labels: data.map((d) => d.region),
              datasets: [
                {
                  label: "Avg Charges",
                  data: data.map((d) => d.charges),
                  backgroundColor: "#1976d2",
                },
              ],
            },
            options: { responsive: true },
          });
        });
      // Smoker vs Non-Smoker (Avg Charges)
      fetch("/api/boxplot-smoker")
        .then((r) => r.json())
        .then((data) => {
          const ctx = document.getElementById("boxplotChart").getContext("2d");
          // Use bar chart for average charges
          const avgCharges = data.map((d) => {
            const arr = d.charges;
            return arr.reduce((a, b) => a + b, 0) / arr.length;
          });
          new Chart(ctx, {
            type: "bar",
            data: {
              labels: data.map((d) => d.smoker),
              datasets: [
                {
                  label: "Avg Charges",
                  data: avgCharges,
                  backgroundColor: "#ff9800",
                },
              ],
            },
            options: { responsive: true },
          });
        });
      // Age average line chart
      fetch("/api/age-avg")
        .then((r) => r.json())
        .then((data) => {
          const ctx = document.getElementById("ageChart").getContext("2d");
          new Chart(ctx, {
            type: "line",
            data: {
              labels: data.map((d) => d.age),
              datasets: [
                {
                  label: "Avg Charges",
                  data: data.map((d) => d.charges),
                  borderColor: "#388e3c",
                  fill: false,
                },
              ],
            },
            options: { responsive: true },
          });
        });
      // Correlation matrix as table and matrix chart
      fetch("/api/corr")
        .then((r) => r.json())
        .then((corr) => {
          const keys = Object.keys(corr);
          // Render as table
          let html = '<table class="table table-bordered"><thead><tr><th></th>';
          keys.forEach((k) => {
            html += `<th>${k}</th>`;
          });
          html += "</tr></thead><tbody>";
          keys.forEach((row) => {
            html += `<tr><th>${row}</th>`;
            keys.forEach((col) => {
              html += `<td>${corr[row][col].toFixed(2)}</td>`;
            });
            html += "</tr>";
          });
          html += "</tbody></table>";
          document.getElementById("corrTable").innerHTML = html;
          // Render as matrix chart (using bubble chart)
          const ctx = document.getElementById("corrChart").getContext("2d");
          const matrixData = [];
          keys.forEach((row, i) => {
            keys.forEach((col, j) => {
              matrixData.push({
                x: j + 1,
                y: i + 1,
                r: Math.abs(corr[row][col]) * 20,
                v: corr[row][col],
              });
            });
          });
          new Chart(ctx, {
            type: "bubble",
            data: {
              datasets: [
                {
                  label: "Correlation",
                  data: matrixData,
                  backgroundColor: matrixData.map((d) =>
                    d.v > 0 ? "#388e3c" : "#e53935"
                  ),
                },
              ],
            },
            options: {
              scales: {
                x: {
                  min: 0,
                  max: keys.length + 1,
                  ticks: { callback: (v) => keys[v - 1] || "" },
                },
                y: {
                  min: 0,
                  max: keys.length + 1,
                  ticks: { callback: (v) => keys[v - 1] || "" },
                },
              },
              plugins: { legend: { display: false } },
              responsive: true,
            },
          });
        });
    </script>
  </body>
</html>
